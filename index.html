<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="Content-Security-Policy" content="default-src 'self'; script-src 'self' 'unsafe-inline' https://unpkg.com https://cdnjs.cloudflare.com https://cdn.tailwindcss.com; style-src 'self' 'unsafe-inline' https://cdnjs.cloudflare.com https://fonts.googleapis.com; img-src 'self' data: blob:; font-src 'self' https://fonts.gstatic.com;">
    <title>D&D 5E Character Sheet PDF Editor - Fill & Download</title>

    <!-- SEO and AI Agent Metadata -->
    <meta name="description"
        content="A web-based tool to fill D&D 5E character sheet PDFs using JSON data. Features live preview, direct editing on PDF overlays, image upload for character portraits, and formatted PDF export.">
    <meta name="keywords"
        content="D&D, Dungeons and Dragons, 5E, character sheet, PDF editor, fillable PDF, character creator">
    <meta name="author" content="Comet PDF Editor">
    <meta name="application-name" content="D&D PDF Editor">
    <meta name="robots" content="index, follow">

    <!-- Open Graph for rich link previews -->
    <meta property="og:title" content="D&D 5E Character Sheet PDF Editor">
    <meta property="og:description"
        content="Fill D&D 5E character sheets with JSON data. Live preview, direct PDF editing, and formatted export.">
    <meta property="og:type" content="website">
    <meta property="og:locale" content="en_US">

    <!-- JSON-LD Structured Data for AI Agents -->
    <script type="application/ld+json">
    {
        "@context": "https://schema.org",
        "@type": "WebApplication",
        "name": "D&D 5E Character Sheet PDF Editor",
        "description": "A client-side web application for filling D&D 5E character sheet PDFs using JSON data with live preview.",
        "applicationCategory": "UtilitiesApplication",
        "operatingSystem": "Any (Browser-based)",
        "offers": {
            "@type": "Offer",
            "price": "0",
            "priceCurrency": "USD"
        },
        "featureList": [
            "Upload any fillable PDF form",
            "Fill form fields using JSON data",
            "Live preview with zoom controls",
            "Direct text editing on PDF overlays",
            "Character portrait image upload",
            "Download filled PDF",
            "Dark mode support",
            "JSON export/import"
        ],
        "browserRequirements": "Requires JavaScript. Works best in modern browsers (Chrome, Firefox, Edge, Safari)."
    }
    </script>

    <script src="https://unpkg.com/pdf-lib@1.17.1/dist/pdf-lib.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
    <script>pdfjsLib.GlobalWorkerOptions.workerSrc = '';</script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            darkMode: 'class',
        }
    </script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/codemirror.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/theme/dracula.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/codemirror.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/mode/javascript/javascript.min.js"></script>
    <link rel="stylesheet" href="src/styles.css">
</head>

<body
    class="bg-gray-100 text-gray-800 h-screen flex flex-col overflow-hidden dark:bg-gray-900 dark:text-gray-100 transition-colors duration-200"
    data-app="dnd-pdf-editor" data-version="2.0">

    <!-- Skip to main content for accessibility -->
    <a href="#pdf-container"
        class="sr-only focus:not-sr-only focus:absolute focus:top-2 focus:left-2 focus:z-50 focus:px-4 focus:py-2 focus:bg-blue-600 focus:text-white focus:rounded">Skip
        to PDF Preview</a>

    <header role="banner" aria-label="Application header with controls"
        class="bg-white border-b border-gray-200 py-2 px-4 shadow-sm flex-none z-20 flex flex-col gap-0 dark:bg-gray-800 dark:border-gray-700">
        <!-- Row 1: Logo and Main Controls -->
        <div class="flex flex-wrap gap-4 justify-between items-center w-full">
            <div class="flex items-center gap-3">
                <div class="bg-gradient-to-br from-purple-600 to-blue-500 text-white p-1.5 rounded-md">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z">
                        </path>
                    </svg>
                </div>
                <div>
                    <h1 class="text-lg font-bold text-gray-900 leading-tight dark:text-white">DnD PDF Editor <span
                            class="text-purple-600">v2</span></h1>
                    <p class="text-xs text-gray-500 dark:text-gray-400">Experimental Overlay Mode</p>
                </div>
            </div>
            <!-- Removed duplicate zoom controls -->
            <!-- Updated Controls -->
            <nav role="toolbar" aria-label="PDF controls and view options"
                class="flex items-center gap-4 bg-gray-50 p-1.5 rounded-lg border border-gray-200 dark:bg-gray-700 dark:border-gray-600">
                <div class="flex items-center gap-2 border-r border-gray-300 pr-3 mr-1 dark:border-gray-500"
                    role="group" aria-label="Zoom controls">
                    <label for="zoom-slider" class="text-xs text-gray-500 font-medium dark:text-gray-300">Zoom:</label>
                    <input type="range" id="zoom-slider" min="10" max="300" value="100"
                        class="w-24 h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer dark:bg-gray-600"
                        oninput="updateZoomLabel(this.value)" onchange="applyZoom(this.value)"
                        aria-valuemin="10" aria-valuemax="300" aria-valuenow="100" aria-label="PDF zoom level">
                    <output id="zoom-level" for="zoom-slider"
                        class="text-xs font-mono w-12 text-center text-gray-600 dark:text-gray-200">100%</output>
                    <button id="btn-autofit" onclick="toggleAutoFit()"
                        class="ml-1 px-2 py-1 text-xs bg-blue-100 text-blue-700 rounded border border-blue-200 font-medium dark:bg-blue-900 dark:text-blue-200 dark:border-blue-800"
                        aria-label="Fit PDF to window width" data-action="auto-fit-toggle">Fit</button>
                </div>

                <!-- Dark Mode Toggle -->
                <div class="flex items-center gap-2 border-r border-gray-300 pr-3 mr-1 dark:border-gray-500"
                    role="group" aria-label="Theme toggle">
                    <button onclick="toggleDarkMode()"
                        class="p-1.5 rounded hover:bg-gray-200 dark:hover:bg-gray-600 text-gray-600 dark:text-gray-300"
                        aria-label="Toggle dark mode" aria-pressed="false" id="dark-mode-btn"
                        data-action="toggle-dark-mode">
                        <span id="dark-mode-icon" aria-hidden="true">🌙</span>
                        <span class="sr-only">Toggle dark mode</span>
                    </button>
                </div>

                <!-- View Toggles -->
                <div class="flex items-center gap-2 border-r border-gray-300 pr-3 mr-1 dark:border-gray-500"
                    role="group" aria-label="Panel visibility toggles">
                    <button onclick="togglePanel('sidebar')" id="btn-toggle-sidebar"
                        class="p-1.5 rounded hover:bg-gray-200 dark:hover:bg-gray-600 text-blue-600 font-medium text-xs"
                        aria-label="Toggle field list sidebar" aria-expanded="true" aria-controls="sidebar-panel"
                        data-action="toggle-sidebar">Runes</button>
                    <button onclick="togglePanel('toolbar')" id="btn-toggle-toolbar"
                        class="p-1.5 rounded hover:bg-gray-200 dark:hover:bg-gray-600 text-blue-600 font-medium text-xs"
                        aria-label="Toggle formatting toolbar" aria-expanded="true" aria-controls="formatting-toolbar"
                        data-action="toggle-toolbar">Format</button>
                    <button onclick="togglePanel('json')" id="btn-toggle-json"
                        class="p-1.5 rounded hover:bg-gray-200 dark:hover:bg-gray-600 text-blue-600 font-medium text-xs"
                        aria-label="Toggle JSON editor panel" aria-expanded="true" aria-controls="json-panel"
                        data-action="toggle-json">JSON</button>
                </div>

                <button id="debug-toggle-btn" onclick="toggleDebug()"
                    class="text-xs font-semibold uppercase tracking-wider px-2 py-1 rounded transition-colors duration-200 text-gray-600 hover:text-gray-800 dark:text-gray-400 dark:hover:text-gray-200"
                    aria-label="Toggle debug mode to show field boundaries" aria-pressed="false"
                    data-action="toggle-debug">Debug</button>
                <button id="download-btn" onclick="downloadPDF()"
                    class="flex items-center gap-2 px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700 transition-colors text-sm font-medium opacity-50 cursor-not-allowed shadow-sm"
                    disabled aria-label="Download filled PDF" aria-disabled="true"
                    data-action="download-pdf">Download</button>
                <button id="verify-btn" onclick="verifyExport()"
                    class="flex items-center gap-2 px-4 py-2 bg-purple-600 text-white rounded-md hover:bg-purple-700 transition-colors text-sm font-medium opacity-50 cursor-not-allowed shadow-sm ml-2"
                    disabled aria-label="Preview filled PDF in new tab" aria-disabled="true"
                    data-action="verify-pdf">Verify Export</button>
            </nav>
        </div>

        <!-- Row 2: Formatting Toolbar -->
        <div class="formatting-toolbar transition-all duration-300 ease-in-out dark:border-gray-700"
            id="formatting-toolbar" role="toolbar" aria-label="Text formatting options for selected field">
            <div class="toolbar-group dark:border-gray-700" role="group" aria-label="Font settings">
                <label for="font-family-select" class="sr-only">Font Family</label>
                <select id="font-family-select"
                    class="toolbar-select dark:bg-gray-700 dark:text-gray-200 dark:border-gray-600" disabled
                    aria-label="Font family (PDF standard fonts only)" data-field="font-family">
                    <option value="Helvetica">Helvetica</option>
                    <option value="Times-Roman">Times New Roman</option>
                    <option value="Courier">Courier</option>
                </select>
                <label for="font--select" class="sr-only">Font Size</label>
                <select id="font-size-select"
                    class="toolbar-select dark:bg-gray-700 dark:text-gray-200 dark:border-gray-600"
                    onchange="applyStyle('fontSize', this.value)" aria-label="Font size in points"
                    data-field="font-size">
                    <option value="">Auto</option>
                    <option value="1">1</option>
                    <option value="2">2</option>
                    <option value="4">4</option>
                    <option value="5">5</option>
                    <option value="6">6</option>
                    <option value="7">7</option>
                    <option value="8">8</option>
                    <option value="9">9</option>
                    <option value="10">10</option>
                    <option value="11">11</option>
                    <option value="12">12</option>
                    <option value="13">13</option>
                    <option value="14">14</option>
                    <option value="15">15</option>
                    <option value="16">16</option>
                    <option value="17">17</option>
                    <option value="18">18</option>
                    <option value="19">19</option>
                    <option value="20">20</option>
                    <option value="21">21</option>
                    <option value="22">22</option>
                    <option value="23">23</option>
                    <option value="24">24</option>
                    <option value="25">25</option>
                    <option value="26">26</option>
                    <option value="27">27</option>
                    <option value="28">28</option>
                    <option value="29">29</option>
                    <option value="30">30</option>
                    <option value="32">32</option>
                    <option value="34">34</option>
                    <option value="36">36</option>
                </select>
            </div>

            <div class="toolbar-group dark:border-gray-700" role="group" aria-label="Text style">
                <button class="toolbar-btn dark:text-gray-300 dark:hover:bg-gray-700" id="btn-bold"
                    onclick="toggleStyle('bold')" aria-label="Toggle bold text" aria-pressed="false"
                    data-action="toggle-bold">
                    <strong aria-hidden="true">B</strong>
                </button>
                <button class="toolbar-btn dark:text-gray-300 dark:hover:bg-gray-700" id="btn-italic"
                    onclick="toggleStyle('italic')" aria-label="Toggle italic text" aria-pressed="false"
                    data-action="toggle-italic">
                    <em aria-hidden="true">I</em>
                </button>
            </div>

            <div class="toolbar-group dark:border-gray-700" role="radiogroup" aria-label="Text alignment">
                <button class="toolbar-btn dark:text-gray-300 dark:hover:bg-gray-700" id="btn-align-left"
                    onclick="applyStyle('align', 'left')" aria-label="Align text left" role="radio" aria-checked="true"
                    data-action="align-left">
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24" aria-hidden="true">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M4 6h16M4 12h10M4 18h16"></path>
                    </svg>
                </button>
                <button class="toolbar-btn dark:text-gray-300 dark:hover:bg-gray-700" id="btn-align-center"
                    onclick="applyStyle('align', 'center')" aria-label="Align text center" role="radio"
                    aria-checked="false" data-action="align-center">
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24" aria-hidden="true">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M4 6h16M7 12h10M4 18h16"></path>
                    </svg>
                </button>
                <button class="toolbar-btn dark:text-gray-300 dark:hover:bg-gray-700" id="btn-align-right"
                    onclick="applyStyle('align', 'right')" aria-label="Align text right" role="radio"
                    aria-checked="false" data-action="align-right">
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24" aria-hidden="true">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M4 6h16M10 12h10M4 18h16"></path>
                    </svg>
                </button>
            </div>

            <div class="toolbar-group dark:border-gray-700" role="group" aria-label="Text color">
                <label for="text-color-picker" class="sr-only">Text color</label>
                <input type="color" id="text-color-picker" class="w-8 h-8 cursor-pointer border-0 p-0 bg-transparent"
                    value="#000000" onchange="applyStyle('color', this.value)" aria-label="Select text color"
                    data-field="text-color">
            </div>

            <div class="flex-grow"></div>
            <output class="text-xs text-gray-400" id="selected-field-name" aria-live="polite"
                aria-label="Currently selected field">No field selected</output>
        </div>
    </header>

    <main class="flex-grow flex overflow-hidden" role="main">
        <aside id="sidebar-panel" role="complementary" aria-label="PDF field list and file controls"
            class="w-64 bg-white border-r border-gray-200 flex flex-col z-10 flex-shrink-0 transition-all duration-300 ease-in-out dark:bg-gray-800 dark:border-gray-700">
            <div class="p-4 border-b border-gray-200 bg-gray-50 dark:bg-gray-800 dark:border-gray-700">
                <label for="pdf-upload"
                    class="flex flex-col items-center justify-center w-full h-20 border-2 border-gray-300 border-dashed rounded-lg cursor-pointer hover:bg-white hover:border-blue-500 transition-all bg-white group"
                    data-action="upload-pdf-dropzone">
                    <div class="flex flex-row items-center gap-2">
                        <svg class="w-5 h-5 text-gray-400 group-hover:text-blue-500" fill="none" stroke="currentColor"
                            viewBox="0 0 24 24" aria-hidden="true">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"></path>
                        </svg>
                        <span class="text-xs font-medium text-gray-500 group-hover:text-blue-600">Upload PDF</span>
                    </div>
                    <input id="pdf-upload" type="file" class="hidden" accept="application/pdf"
                        aria-label="Upload a fillable PDF file" />
                </label>
                <div id="file-name-display"
                    class="mt-2 text-xs text-gray-600 truncate hidden font-medium pl-2 border-l-2 border-blue-500">
                </div>
                <button id="load-sample-btn"
                    class="mt-2 w-full px-3 py-1.5 text-xs bg-purple-50 text-purple-700 rounded-md hover:bg-purple-100 transition-colors border border-purple-200 font-medium"
                    aria-label="Load the official D&D 5E fillable character sheet" data-action="load-sample">Load
                    Sample D&D Sheet</button>
                <button
                    class="mt-2 w-full px-3 py-1.5 text-xs bg-gray-100 text-gray-700 rounded-md hover:bg-gray-200 transition-colors border border-gray-300 font-medium flex items-center justify-center gap-1"
                    aria-label="Copy all PDF field names and descriptions as CSV to clipboard"
                    data-action="copy-fields-csv">
                    <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24" aria-hidden="true">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M8 5H6a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2v-1M8 5a2 2 0 002 2h2a2 2 0 002-2M8 5a2 2 0 012-2h2a2 2 0 012 2m0 0h2a2 2 0 012 2v3m2 4H10m0 0l3-3m-3 3l3 3">
                        </path>
                    </svg>
                    Copy Field List (CSV)
                </button>
            </div>
            <nav class="flex-grow overflow-y-auto p-2 bg-white dark:bg-gray-800 dark:text-gray-300"
                aria-label="Available PDF form fields">
                <div id="field-list" class="space-y-0.5" role="list"
                    aria-label="Clickable list of PDF field names - click to add to JSON or upload image"></div>
            </nav>
        </aside>

        <section class="flex-grow bg-gray-200 flex flex-col h-full overflow-hidden relative dark:bg-gray-900"
            role="region" aria-label="PDF preview and editing area">
            <div id="render-toast" role="status" aria-live="polite" aria-atomic="true"
                class="absolute top-4 left-1/2 transform -translate-x-1/2 z-10 bg-gray-900 text-white text-xs px-4 py-2 rounded-lg opacity-0 transition-opacity duration-300 pointer-events-none shadow-lg font-medium min-w-[150px]">
                <div class="flex justify-between items-center mb-1"><span
                        id="render-status-text">Rendering...</span><span id="render-percent">0%</span></div>
                <div class="w-full bg-gray-700 h-1 rounded-full overflow-hidden" role="progressbar" aria-valuenow="0"
                    aria-valuemin="0" aria-valuemax="100" aria-label="PDF rendering progress">
                    <div id="render-progress-bar" class="bg-blue-500 h-full w-0 transition-all duration-200 ease-out">
                    </div>
                </div>
            </div>
            <div id="pdf-container" class="pdf-container flex-grow overflow-auto p-8 flex flex-col items-center"
                role="document" aria-label="PDF pages with editable form field overlays" tabindex="0">
                <div id="empty-state" class="text-center mt-32 text-gray-400 select-none w-full" aria-live="polite">
                    <p class="font-medium text-sm">No PDF Loaded</p>
                    <p class="text-xs mt-1">Upload a PDF or click "Load Sample D&D Sheet"</p>
                </div>
            </div>
        </section>

        <section id="json-panel" role="region" aria-label="JSON data editor for PDF form values"
            class="w-96 bg-gray-900 border-r border-gray-700 flex flex-col flex-shrink-0 transition-all duration-300 ease-in-out dark:border-gray-600">
            <div
                class="p-3 border-b border-gray-700 bg-gray-800 flex justify-between items-center shadow-sm z-10 dark:bg-gray-800 dark:border-gray-600">
                <div class="flex items-center gap-2">
                    <h2 class="text-sm font-semibold text-gray-200" id="json-panel-heading">JSON Data</h2>
                    <span id="json-status" role="status" aria-live="polite"
                        class="text-xs px-1.5 py-0.5 rounded bg-green-500/20 text-green-400">Valid</span>
                </div>
                <div class="flex items-center gap-2" role="group" aria-label="JSON file operations">
                    <button onclick="importJSON()" class="text-xs text-blue-400 hover:text-blue-300 font-medium"
                        aria-label="Import JSON data from file" data-action="import-json">Import</button>
                    <button onclick="exportJSON()" class="text-xs text-blue-400 hover:text-blue-300 font-medium"
                        aria-label="Export current JSON data to file" data-action="export-json">Export</button>
                    <span class="text-gray-600" aria-hidden="true">|</span>
                    <button onclick="loadSampleData()" class="text-xs text-blue-400 hover:text-blue-300 font-medium"
                        aria-label="Reset JSON to sample character data" data-action="reset-json">Reset</button>
                </div>
            </div>
            <div class="flex-grow relative overflow-hidden" id="editor-container">
                <textarea id="json-input" aria-label="JSON data editor for PDF form values"></textarea>
            </div>
        </section>
    </main>


    <script src="src/app.js" defer></script>
</body>


</html>
